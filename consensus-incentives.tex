\documentclass[11pt,a4paper]{article}

\setlength {\marginparwidth }{2cm}

\usepackage[margin=2.5cm]{geometry}
\usepackage{todonotes}
\usepackage[automake]{glossaries}
\usepackage{graphicx}
\usepackage{microtype}
\usepackage{listings}
\usepackage{color}
\usepackage{amssymb,amsmath}
\usepackage{mathpazo}
\usepackage{accents}
\usepackage{longtable,booktabs}
\usepackage{dcolumn}
\usepackage{pgf}
\usepackage{mathrsfs}
\usetikzlibrary{shapes.geometric}
\usetikzlibrary{matrix}
\usepackage{natbib}
\usepackage{hyperref}
\usepackage[capitalise,noabbrev,nameinlink]{cleveref}
\hypersetup{
  pdftitle={Algorand Consensus Incentivisation},
  pdfborder={0 0 0},
  breaklinks=true
}
\graphicspath{ {./images/} }

\definecolor{dkgreen}{rgb}{0,0.6,0}
\definecolor{gray}{rgb}{0.5,0.5,0.5}
\definecolor{pink}{rgb}{0.92,0.2,0.86}

\lstset{frame=tb,
  language=C,
  aboveskip=3mm,
  belowskip=3mm,
  showstringspaces=false,
  columns=flexible,
  basicstyle={\ttfamily},
  numbers=none,
  numberstyle=\tiny\color{pink},
  keywordstyle=\color{pink},
  commentstyle=\color{pink},
  stringstyle=\color{pink},
  breaklines=true,
  breakatwhitespace=true,
  tabsize=3
}

\DeclareMathOperator{\dom}{dom}
\newcommand\restrict[2]{\left.#1\right||_{#2}}
\newcommand\deltavar[1]{\accentset{\Delta}{#1}}


\makeglossaries
\newglossaryentry{PPOS}
{
    name={Pure Proof of Stake},
    description={a consensus algorithm based on verifiable random functions over elliptic curves, which provide a
                 mechanism of cryptographic sortition. Naturally incentivises non-pooled block production.}
}
\newglossaryentry{POW}
{
    name={Proof of Work},
    description={a consensus algorithm based on symmetric hash functions, where a newly mined block's digest is under a
                 specific threshold. Does not naturally incentivise non-pooled block production.}
}
\newglossaryentry{Staker}
{
    name={Staker},
    description={an individual who is actively participating in the security of the network by running a participation
                 node, with valid participation keys, backed by a sum of Algo}
}
\newglossaryentry{Block-Reward}
{
    name={Block-Reward},
    description={a sum of Algo paid to the participation account of an active Staker, when the Staker has successfully
                 produced a valid and network-wide accepted block.}
}
\newglossaryentry{FeeSink}
{
    name={Fee Sink},
    description={an account, (Y76M3MSY6DKBRHBL7C3NNDXGS5IIMQVQVUAB6MP4XEMMGVF2QWNPL226CA), which receives all Fees 
                 generated by transactions on Algorand mainnet.}
}
\newglossaryentry{KeyReg}
{
    name={Key Registration Transaction},
    description={a native Algorand transaction type that is used to register an underlying account's balance as an 
                 active part of the global stake utilised by Consensus.}
}
\newglossaryentry{SpendKey}
{
    name={Spending Key},
    description={the primary private key for a given Algorand account, confers the right to spend/move the account's 
                 funds upon the holder.}
}
\newglossaryentry{PartKey}
{
    name={Participation Key},
    description={a secondary private key, associated with the primary private key/account via signature from the primary
                 private key, embued with the right to sign messages on behalf of the associated account during consensus.}
}
\newglossaryentry{Blockseed}
{
    name={Blockseed},
    description={a pseudo-random number generated for each block. Its value is based on various pieces of information 
                 from the blockchain. It is used as part of the sortition algorithm.}
}

\begin{document}

\title {Algorand Consensus Incentivisation \\
       {\large \sc An Algorand Foundation discussion paper}}
\date  {Version 0.8, 24th November 2023}
\author{
    John Woods \\ 
    {\small \texttt{john@algorand.foundation}} \\
    {\small \texttt{john@postquantum.dev}} \\
\and 
    Michele Treccani \\
    {\small \texttt{michele@algorand.foundation}}
\and 
    John Jannotti \\
    {\small \texttt{john.jannotti@algorand.com}}
\and 
    Naveed Ihsanullah \\
    {\small \texttt{naveed@algorand.foundation}}
}

\maketitle

\section{Purpose}
The goal of this project is to engineer a native solution at layer 1, modifying the Algorand protocol to 
\emph{incentivise} the execution of consensus via block production rewards in Algo, Algorand's native token. \\

\textbf{The technical goals of this project are:}

\begin{enumerate}
    \item Define the economic aspects of the design (source of funds, payout function, non-functional requirements) - 
        this is the primary Foundation output.
    \item Define the technical design (protocol level augmentations, code-level changes, functional requirements) 
        - secondary goal, Inc will lead.
    \item Define the approach to mitigate gamification (Key surrender, Absenteeism, Vote neglect) - secondary goal.
\end{enumerate}

\pagebreak

\tableofcontents

\pagebreak

\section{Acknowledgements}
The ideas presented herein are inspired by and based on discussions with individuals from Algorand Foundation, 
Algorand Technologies (previously Inc), including the research and engineering groups, specifically: Michele Treccani, 
Silvio Micali, Paul Riegle, Gary Malouf, Eric Wragge, John Jannotti, Naveed Ihsanullah \& Bruno Martins.

\pagebreak

\section{Context}
Algorand employs \gls{PPOS} (glossary below) as a means of reaching consensus. The security of the decentralised network 
is predicated on the total count of Algo tokens which are actively staked at any given moment, as a percentage of the 
total circulating supply. Notably, Algorand's liveness relies upon at least $\sim$80\% of the
participating (``online'') stake to actively and honestly taking part in the consensus protocol in order to produce blocks. \\ 

Algorand's original thesis contended, a priori, that a sufficient number of end-users would be naturally incentivised to 
run a node and contribute to online stake, motivated by the desire to secure their own funds, and as a corollary the 
network. However, a posteriori, it has been observed that as a consequence of the cost to run a participation node with 
high uptime, and indeed the technical expertise required to both instantiate and maintain a node, a critical mass of 
end-user contribution has not been reached. \\

In fact, as the distribution of large holders has slowly fragmented, and a larger proportion of the supply has been held 
by an increasingly less concentrated set of individuals, online stake has notably \emph{dropped}. The aforementioned 
friction is too much for most individuals to contribute actively to network security. \\ \\

This paper proposes potential solutions, at a protocol level, to encourage end-users to actively participate with their Algo.
Additionally, we introduce the concept of financial incentives to reward participation, with the aim of materially increasing 
the total percentage of Algo in circulating supply which are participating in consensus. 

\pagebreak

\section{Solution design}
Here we outline the technical solution design for payment of consensus incentives, by the protocol, without manual 
intervention. 

\subsection{Incentives from Fees}
Henceforth, we use the term “mined incentives” to refer to the proportion of incentives yielded from the act of proposing 
a block which are directly attributable to Fees. As of 2023, the global Fee volume is unsubstantive. That said, we 
should introduce this mechanism now as any sustainable approach to consensus incentivsation will necessitate the 
consumption of Fees to pay block proposers. \\

The mining mechanism must be built into the L1 protocol, as it diverts funds from the global \gls{FeeSink}. The 
following technical approach should be sufficient to correctly pay out mined incentives.

\begin{enumerate}
    \item When \texttt{proto.EnableMining} add \texttt{Proposer} and \texttt{FeesCollected} fields to the block header.
    \item Choose \texttt{proto.MiningPercent} which is the percentage of Algo paid in Fees that should go to the 
          proposer of the block instead of the \gls{FeeSink}.
    \item At the start of block \texttt{n+1}, move \texttt{MiningPercent * block[n].FeesCollected} from the 
          \gls{FeeSink} to \texttt{block[n].Proposer}.
    \item Outlaw spending from the \gls{FeeSink} to ensure the funds above are available in block \texttt{n+1}.

\end{enumerate}

The movement is executed at the start of a given block \texttt{n+1} instead of during block \texttt{n} because a 
multi-participant node builds a block \textit{before} it knows which of its accounts might actually be the
proposer. Between blocks, the funds remain in the \gls{FeeSink}.

\subsection{Economic considerations} \label{subsec:eco}
In addition to the incentives generated by the Fee market, in the short to medium term additional funds will be required
to ensure incentives are substantive whilst the network's transaction volume increases. Thus the Algorand Foundation 
will contribute an additional sum of Algo to supplement the incentives generated by Fees. \\ \\
To the end user, the \gls{Block-Reward} paid to the proposers account will be congruent, that is, the portion of the
reward which represents the AF contribution, and the portion of the reward which represents the Fee contribution will
seamlessly combine.

\pagebreak

\subsection{Payout function}
The combined incentives (Fees and supplemental incentives) described above will payout following a time dependent 
function, where the emission implies deflation.

Consider the following two emission function definitions:

Defined below is a linear reward function, which at a given point in time (defined by round number $\eta$) evaluates to 
a \gls{Block-Reward} in Algo:\\

\textbf{First we define the emission shape, with a linear decrease:}
\[
R(\eta) = (1- \frac{\eta}{\mathcal{N}})
\]

\textbf{then, adding a normalisation factor:}
\[
\mathcal{K} = \sum_{\eta=1}^\mathcal{N}R(\eta)=(\mathcal{N} -  \frac{\mathcal{N}(\mathcal{N}+1)}{2\times \mathcal{N}})  
\]

\textbf{$\ni$ the payout function is defined as:}
\[
\mathcal{R}(\eta) = \mathcal{M} \times R(\eta) \times \frac{1}{\mathcal{K}}
\]

\textbf{\emph{Where:}}
\begin{align*}
    \mathcal{M} & : \text{Total units for incentive (e.g., 500 million Algo).} \\
    \mathcal{B} & : \text{Block time (e.g., 3 seconds).} \\
    \mathcal{T} & : \text{Total duration for the payout, expressed in seconds (e.g., 5 years).} \\
    \mathcal{N} & : \text{Total number of blocks over the payout period} = \frac{\mathcal{T}}{\mathcal{B}}.\\
\end{align*}

Whilst a linear payout is \textit{reasonable}, we could also consider a function with a configurable exponential decay 
(also defined by round number $\eta$), which may be more fitting given Algorand's capped, inherently deflationary 
supply: \\ 

\textbf{First we define the emission shape, with an exponential decrease:}
\[
R'(\eta)= e^{-\rho\frac{\eta}{\mathcal{N}}}
\]

\textbf{then, adding a normalisation factor:}
\[
\mathcal{K} = \sum_{\eta=1}^\mathcal{N}R'(\eta)= \frac{1-e^{-\rho}}{1-e^{-\frac{\rho}{\mathcal{N}}}}
\]

\textbf{$\ni$ the payout function is defined as:}
\[
\mathcal{R'}(\eta)= \mathcal{M}\times e^{-\rho\frac{\eta}{\mathcal{N}}} \frac{1}{\mathcal{K}}
\]

\textbf{\emph{Where:}}
\begin{align*}
\rho & : \text{Rate of decay.} \\
\end{align*}

Here the shape of the curve would depend on the value of \(\mathcal{K}\). Where the lower the value of \(\mathcal{K}\), 
the more elongated the curve. \\

\emph{Note: With the development of "Dynamic $\lambda$" (essentially dynamic round-times, where the time-to-wait for the
lowest VRF proposal is dynamically calculated, optimised to ignore some slow percentile of proposers), it is likely
prudent to consider a mechanism to scale the payout of the functions proposed above as non-static round times will no 
longer provide a linear approximation of time.}

\subsection{Frequency}
The payout function for the \glsplural{Block-Reward} will execute on a periodic basis. The payout will occur every 
$\eta$ block(s). At the time of writing the average block time is \emph{3.3 seconds}, and the expected payout is 
\textit{per round}. 

\pagebreak

\subsection{Game mitigations/Anti-fragility}
Below we describe the primary attack vectors and game-theory aspects as they pertain to the proposed implementation 
above.

\subsubsection{Absenteeism} \label{subsubsec:absenteeism}

\paragraph{Concern:} \mbox{}\\
Absenteeism refers to stakeholders registering their Algorand account online, but 
subsequently failing to participate in protocol operations (such as proposing and validating blocks). If a sufficient 
percentage of active stake declares itself online but does not do the work to participate in the consensus protocol the 
blockchain will stall. Recovery from this stall requires that the derelict stake eventually participates or a network 
hard-fork is executed to bypass the defaulting Algo from being considered. 

\paragraph{Mitigation:} \mbox{}\\
We propose a novel solution to Absenteeism which essentially empowers the network to suspend delinquent participants/
accounts from the staking set. Where that participant/account has failed to execute their incumbent responsibilities.
As part of this solution we will introduce a new transaction type which will supplement the standard \gls{KeyReg} 
transaction mechanism with a new type dedicated to "re-enrollment" of an account in the staking set should it have been 
suspended from the staking set by the network mistakenly.

This will ensure false positives have a mechanism by which they can re-engage in consensus without downtime.
\emph{Note: this solution operates at a consensus level.}

The approach is as follows:

\begin{itemize}
    \item Consider one's stake always represents some $\mathcal{X}\%$ of $\mathcal{Y}$, one's portion of the global 
          stake.
    \item Said portion will imply a probability distribution across the staking set, defining a threshold with regard to 
          the probable number of successful block proposals per account, a quantitative threshold which can be used to assess 
          the likelihood of an individual acting in the best interest of the network.
    \item If an account falls foul of this threshold, the network will suspend the participant from the staking
          set, for example where an account's count of successful proposals is significantly below the statistically 
          implied threshold.
    \item There is of course a possibility that an individual was just 'unlucky' rather than inactive. In such 
          circumstances their node can trivially post a re-enrollment transaction which is, critically, signed by the 
          node's \gls{PartKey}, not their \gls{SpendKey}.
    \item Thus, the network can suspend misbehaving entities, including those who may not be bad actors but whose stake 
          is unreliable and detrimental to the network, whilst simultaneously providing a mechanism for entities who
          were incorrectly suspended to reassert their commitment to the network.
    \item To avoid suspension in cases where an account may simply receive a large portion of Algo which skews the implied 
          threshold, a \emph{constant} grace period will be observed prior to suspension to allow accounts to proactively
          respond, prior to any action being applied.
    \item This approach will utilise \glsplural{PartKey}, and not \glsplural{SpendKey}. The process will
          also not require additional \gls{KeyReg} transactions.
    \item This approach effectively provides "Garbage Collection" for consensus, permitting relatively significant 
          portions of global stake (5\% to 10\%), within a reasonable \emph{rolling} time period, to ungracefully exit 
          consensus ad-infinitum without detriment to the network.
    \item As an additional check of liveness, nodes could be requested to ack in response to challenges based 
          on \glsplural{Blockseed}, (which are notably unpredictable and impossible to influence). This approach would 
          permit a targetted percentage subset of the active staking set to be assessed, asserting their liveness, and
          suspended where an ack is not provided. This mechanism could be executed every \(\mathcal{Z}\) rounds, with the 
          set of participants based on some deterministic slice of the \gls{Blockseed}, for example by comparing each 
          stakers address with some \(\mathcal{B}\) byte portion of the \gls{Blockseed}. The challenge too would be 
          predicated on \gls{Blockseed}, and be trivially computable.
    \item In order to discourage unreliable consensus execution, when an account is suspended it should incur a small
          but substantive expense in order to return to online status. We may want to bound this cost with an 
          integer limit value in the initial \gls{KeyReg}, controlling the number of times an account can reassert. This
          bound allows a security conscious participant to be sure that their \gls{PartKey} cannot be used to drain
          their account.

\end{itemize} \mbox{} \\

Finally, minimum and maximum staking values may be enforced in order for an account to receive a \gls{Block-Reward}.

A minimum, for example, $8,192$ Algo, $16,384$ Algo, $32,768$ Algo, would serve two purposes, first, it sets a hard
upper bound on the total number of incentive-eligible participating nodes. This bound
makes it practical to track all participating accounts in active memory, which is required to ensure absenteeism checks
are time bound, second it will likely deter intermittent node operations by "micro" accounts. \\ 

A staking ceiling encourages large accounts to split their stake across multiple accounts which, where split across
multiple nodes, adds stall resilience to the network's consensus. Such a limit would likely be between $2^{16}$ and
$2^{17}$ Algo. \\ \\

\pagebreak

\subsubsection{Pooling}

\paragraph{Concern:} \mbox{}\\
The liveness of the Algorand protocol requires that $\sim$80\% of the participating stake is held by honest participants
. While participation in Algorand's consensus algorithm is neither computationally burdensome nor operationally complex in 
an absolute sense, it may still prove to be beyond the technical capability of the average Algorand user, who may not
be familiar with managing computer systems. These participants may be likely to pool their Algo with a node operator who promises to participate on their behalf and 
return their rewards for an operational fee. Today this is possible without risking the Algo owner’s principal because 
participation activity involves a secondary \gls{PartKey}, associated with, but not controlling spend from the 
payment account. If users choose to delegate their \gls{PartKey} to a pooling service, this may concentrate stake with a single entity, posing a risk to network safety through potential accidents or malicious actions, 
where, as outlined in the section above on Absenteeism, \ref{subsubsec:absenteeism} a stall could occur. \\ \\
This scenario cannot be meaningfully mitigated by limiting the maximum participation from a particular account, 
node or IP address as a Sybil-attack will trivially bypass such protections.

\paragraph{Mitigation:} \mbox{}\\
Some high-level mitigations and anti-fragility measures have already been baked into the protocol. For example, if a
\gls{PartKey} expires without re-registration, the network will gracefully remove the participant from the staking set.
Additionally, the Foundation will work directly with potential pool operators to provide education and set operational
best practice, including providing play-books. \\ \\
Properly run pools will be beneficial to the network, where appropriate volumes of stake are separated over
participation nodes which are professionally run and exhibit high-availability. Finally, an over-abundance of online accounts on a given participation node is naturally discouraged, running a participation node with more than 
$/sim$3 accounts present will result in a degradated performance during execution of consensus, resulting in 
lost rewards.

\pagebreak

\subsubsection{Modified Clients}

THIS SECTION NEEDS LIVE DISCUSSION

\paragraph{Concern:} \mbox{}\\
A strategy to earn consensus rewards whilst also minimizing the network and computational resources required whilst 
participating, is to participate through a bespoke, modified, Algorand node. The official Algorand node implementation 
maintains substantial local state reflecting the current balance tree of the Algorand blockchain. This reference 
implementation is usually executed on high-end hardware to ensure that the responsibility of consensus execution (such 
as block proposal from current queued transactions and proposal verification based on current balances) can be completed 
in the smallest quanta of time. Considerable network and computational network resources may also be required for the 
algorithm processing and messaging passing required. Thus, a sophisticated attacker may construct a customised node 
implementation which avoids the primary resource intensive activities such as keeping in parity with other node's 
blockchains, proposing empty blocks or falsely validating proposed blocks without actually checking the payload - or 
equivalent damaging shortcuts. 

\paragraph{Mitigation:} \mbox{}\\
Conceptually, mitigation is trivial, the protocol should refuse payout should it be in a block for which consensus gets 
past period 0. Unfortunately, this would add significant complexity, because the consensus period is not known at block 
construction time. In fact, the consensus period of a given block is not, itself, subject to consensus, so two nodes may 
disagree about when a block was agreed to.

Therefore, to implement this mitigation we must both delay the payout until a later round (creating complexity with 
regard to deferred payouts) and in that later round, a proposer would need to supply their vote bundle from the earlier 
round to justify their claim that the previous round reached consensus in a given period.

Given execution of consensus/the VRF is computationally inconsequential, it's highly unlikely there is significant 
benefit to be garnered from partial execution of consensus.


\pagebreak

\subsection{Fees}
As described above in \ref{subsec:eco}, serious consideration must be given to the Fee dynamics in the short to medium 
term. Whilst we absolutely need to ensure Algorand stays inexpensive to use, we must also balance this with the need
to secure the network in perpetuity. This may imply a Fee market, Fee increase or both. Notwithstanding, Algorand's 
vision remains unchanged. A vision which precludes a costly fee model.

\pagebreak

\section{Conclusion}
We believe that incentivised consensus is the right next step for the protocol. It should yield a more decentralised,  
more secure network, and critically, one which is secure in perpetuity, even in the context of a highly uniform token
distribution. \\ 

The implementation of the changes discussed herein is a work in progress, the following PRs track that work:

\begin{itemize}
    \item \emph{PR 5740} - \textbf{Incentives: Implements "Mining" - diverting a portion of fees to proposers}:\\
          \href{https://github.com/algorand/go-algorand/pull/5740}{github.com/algorand/go-algorand/pull/5740} \\
    \item \emph{PR 5757} - \textbf{Incentives: Suspend "absentee" accounts that don't propose}:\\
          \href{https://github.com/algorand/go-algorand/pull/5757}{github.com/algorand/go-algorand/pull/5757} \\
    \item \emph{PR 5799} - \textbf{Incentives: Heartbeat to keep an unlucky node online}:\\
          \href{https://github.com/algorand/go-algorand/pull/5799}{github.com/algorand/go-algorand/pull/5799}
\end{itemize}

\pagebreak

\printglossaries

\pagebreak

\end{document}
